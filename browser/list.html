<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RMRK tools demo - NFT list</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/water.css@2/out/dark.css"
    />
  </head>
  <body>
    <style></style>
    <h1>Consolidator testing page</h1>

    <select name="account_picker" id="account_picker"></select>

    <h2>Minted collections</h2>
    <div id="collections"></div>
    <hr />
    <h2>Minted NFTs</h2>
    <div id="nfts"></div>
    <hr />
    <h2>Invalid calls</h2>
    <div id="bad"></div>
    <hr />
    <script src="ipfs.js"></script>
    <script src="rmrk-tools.js"></script>
    <script src="polkadot-utils.js"></script>
    <script>
      const { extensionDapps, utilCrypto, util, api } = window.polkadotUtils;
      start();

      async function start() {
        let myApi = await initWeb3Connection();
        await initWeb3Login();
      }

      async function initWeb3Login() {
        extensionDapps.web3Enable("RMRK Test").then(function () {
          if (!extensionDapps.isWeb3Injected) {
            alert(
              "You need a Web3 enabled browser to log in with Web3. The easiest solution is probably to install the Polkadot{js} extension."
            );
          } else {
            extensionDapps.web3Accounts().then(async (accounts) => {
              console.log(accounts);
              let picker = document.querySelector("#account_picker");
              let options = "";
              for (acc of accounts) {
                options += `<option value='${acc.address}'>${
                  acc.meta.name + " - " + acc.address
                }</option>`;
              }
              picker.innerHTML = options;
              await initRest();
            });
          }
        });
      }

      async function initRest() {
        console.log("Loading dump...");
        async function main() {
          const node = await ipfs.create();
          const version = await node.version();

          console.log("IPFS Node version:", version.version);

          const data = uint8ArrayConcat(
            await all(
              node.cat("QmVUCSXjuBXC6WJga2yckM3seXJj1MNKgFk6VLB34ExhhW")
            )
          );
          const dump = JSON.parse(util.u8aToString(data));
          //console.log(dump);
          const consolidator = new rmrkTools.Consolidator();
          const consolidated = consolidator.consolidate(
            rmrkTools.utils.getRemarksFromBlocks(dump)
          );
          console.log(consolidated);
          let collBox = "";
          for (const coll of consolidated.collections) {
            collBox += `
            <div class='collection'>
              <h3>${coll.name} (${coll.symbol}) #${coll.block}</h3>
              <h4>${coll.id}</h4>
              <p>Max: ${coll.max}</p>
              <p>Issuer: ${coll.issuer}</p>
            `;
            if (coll.changes.length > 0) {
              for (let change of coll.changes) {
                collBox += `
                <ul>
                  <li>#${change.block}: field ${change.field}, ${change.old} => ${change.new} by ${change.caller}</li>
                </ul>
                `;
              }
            }
            collBox += `</div><hr>`;
          }
          document.querySelector("#collections").innerHTML = collBox;

          let nftBox = "";
          for (const nft of consolidated.nfts) {
            nftBox += `
            <div class='nft'>
              <h3>${nft.name} (${nft.instance}) #${nft.block}</h3>
              <h4>${nft.getId()}, collection ${nft.collection}</h4>
              <p>Transferable: ${
                nft.transferable > 0 ? nft.transferable : "No"
              }</p>
              <p>Burned: ${
                nft.burned == ""
                  ? "No"
                  : nft.burned
                      .replace("<consume>", "")
                      .replace("</consume>", "")
              }</p>
              <p>Owner: ${nft.owner}</p>
              <p>For sale: ${
                nft.forsale > BigInt(0) ? nft.forsale.toString() : "Not listed"
              }
            `;
            if (nft.changes.length > 0) {
              for (let change of nft.changes) {
                nftBox += `
                <ul>
                  <li>#${change.block}: field ${change.field}, ${change.old} => ${change.new} by ${change.caller}</li>
                </ul>
                `;
              }
            }
            nftBox += `</div><hr>`;
          }
          document.querySelector("#nfts").innerHTML = nftBox;

          let invalids = "";
          for (const inv of consolidated.invalid) {
            invalids += `<table>
              <tr>
                <td>OP_TYPE</td>
                <td>${inv.op_type}</td>
              </tr>
              <tr>
                <td>Block</td>
                <td>${inv.block}</td>
              </tr>
              <tr>
                <td>Caller</td>
                <td>${inv.caller}</td>
              </tr>
              <tr>
                <td>Message</td>
                <td>${inv.message}</td>
              </tr>
              <tr>
                <td>Object ID</td>
                <td>${inv.object_id}</td>
              </tr>
              </table><hr>`;
          }
          document.querySelector("#bad").innerHTML = invalids;
        }

        main();
      }

      async function initWeb3Connection() {
        try {
          const wsProvider = new api.WsProvider("ws://127.0.0.1:9944");
          myApi = await api.ApiPromise.create({ provider: wsProvider });
        } catch (e) {
          console.error(e);
        }
      }
    </script>
  </body>
</html>
